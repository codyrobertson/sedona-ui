{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "swap-widget",
  "type": "registry:ui",
  "title": "Swap Widget",
  "description": "Complete token swap interface with slippage controls and quote management",
  "dependencies": [
    "lucide-react"
  ],
  "devDependencies": [],
  "registryDependencies": [
    "swap-utils",
    "button",
    "popover",
    "token-avatar"
  ],
  "files": [
    {
      "path": "components/ui/swap-widget.tsx",
      "type": "registry:ui",
      "content": "\"use client\"\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport {\n  formatNumber,\n  formatUSD,\n  sanitizeNumericInput,\n  parseBalance,\n  getSlippageMultiplier,\n  getPriceImpactColor,\n  type Token,\n} from \"@/lib/swap-utils\"\nimport { Button } from \"@/components/ui/button\"\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\"\nimport {\n  ChevronsUpDown,\n  Settings,\n  ArrowDownUp,\n  Loader2,\n  RefreshCw,\n  AlertTriangle,\n} from \"lucide-react\"\nimport { TokenAvatar } from \"@/components/ui/token-avatar\"\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n// Token interface imported from swap-utils\nexport type { Token }\n\nexport interface SwapQuote {\n  receiveAmount: string\n  exchangeRate: number\n  priceImpact: number\n  minReceived: string\n  networkFee?: string\n  expiresAt?: number\n  metadata?: Record<string, unknown>\n}\n\nexport interface SwapError {\n  code: \"QUOTE_FAILED\" | \"INSUFFICIENT_LIQUIDITY\" | \"NETWORK_ERROR\" | \"QUOTE_EXPIRED\" | \"AMOUNT_TOO_SMALL\" | \"AMOUNT_TOO_LARGE\" | \"UNKNOWN\"\n  message: string\n}\n\nexport type SwapStatus = \"idle\" | \"quoting\" | \"ready\" | \"swapping\" | \"success\" | \"error\"\n\nexport interface SwapWidgetProps {\n  payToken: Token\n  receiveToken: Token\n  slippage?: string\n  slippagePresets?: string[]\n  nativeGasReserve?: string\n  quoteRefreshInterval?: number\n  quoteDebounceMs?: number\n  disabled?: boolean\n  disabledMessage?: string\n  onQuoteRequest?: (params: {\n    payToken: Token\n    receiveToken: Token\n    payAmount: string\n    slippage: string\n  }) => Promise<SwapQuote | null>\n  onSwap?: (params: {\n    payToken: Token\n    receiveToken: Token\n    payAmount: string\n    receiveAmount: string\n    minReceived: string\n    slippage: string\n    quote: SwapQuote\n  }) => Promise<void>\n  onFlip?: () => void\n  onPayTokenSelect?: () => void\n  onReceiveTokenSelect?: () => void\n  onError?: (error: SwapError) => void\n  className?: string\n}\n\n// =============================================================================\n// SUB-COMPONENTS\n// =============================================================================\n\ninterface SwapCardProps {\n  value: string\n  onChange: (value: string) => void\n  token: Token\n  usdValue: number\n  onTokenSelect?: () => void\n  disabled?: boolean\n  isCalculating?: boolean\n  hasError?: boolean\n  errorMessage?: string\n}\n\nconst SwapCard = ({\n  value,\n  onChange,\n  token,\n  usdValue,\n  onTokenSelect,\n  disabled = false,\n  isCalculating = false,\n  hasError = false,\n  errorMessage,\n}: SwapCardProps) => {\n  const inputRef = React.useRef<HTMLInputElement>(null)\n\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const sanitized = sanitizeNumericInput(e.target.value, token.decimals || 9)\n    onChange(sanitized)\n  }\n\n  const handleCardClick = (e: React.MouseEvent) => {\n    if ((e.target as HTMLElement).closest(\"button\")) return\n    inputRef.current?.focus()\n  }\n\n  return (\n    <div\n      onClick={handleCardClick}\n      className={cn(\n        \"rounded-xl border p-3 transition-all cursor-text\",\n        \"focus-within:ring-2 focus-within:ring-primary/50 focus-within:border-primary\",\n        hasError\n          ? \"border-destructive bg-destructive/5 focus-within:ring-destructive/50 focus-within:border-destructive\"\n          : \"border-border bg-card\"\n      )}\n    >\n      <div className=\"flex items-center gap-3\">\n        <TokenAvatar ticker={token.symbol} size=\"md\" imageUrl={token.imageUrl} />\n\n        {isCalculating ? (\n          <div className=\"flex-1 flex items-center\">\n            <Loader2 className=\"w-5 h-5 text-muted-foreground animate-spin\" />\n          </div>\n        ) : (\n          <input\n            ref={inputRef}\n            type=\"text\"\n            inputMode=\"decimal\"\n            placeholder=\"0\"\n            value={value}\n            onChange={handleChange}\n            disabled={disabled}\n            className={cn(\n              \"flex-1 min-w-0 bg-transparent text-2xl font-semibold\",\n              \"placeholder:text-muted-foreground/50\",\n              \"focus:outline-none\",\n              \"disabled:opacity-60 disabled:cursor-not-allowed\"\n            )}\n          />\n        )}\n\n        <button\n          type=\"button\"\n          onClick={onTokenSelect}\n          disabled={disabled}\n          className=\"flex items-center gap-1 px-3 py-2 rounded-full bg-muted hover:bg-muted/80 transition-colors disabled:opacity-50 flex-shrink-0\"\n        >\n          <span className=\"text-sm font-semibold\">{token.symbol}</span>\n          <ChevronsUpDown className=\"w-4 h-4 text-muted-foreground\" />\n        </button>\n      </div>\n\n      <div className=\"flex items-center justify-between mt-2 text-xs\">\n        <span className={cn(hasError ? \"text-destructive\" : \"text-muted-foreground\")}>\n          {errorMessage || formatUSD(usdValue)}\n        </span>\n        <span className=\"text-muted-foreground\">\n          {formatNumber(token.balance)} {token.symbol}\n        </span>\n      </div>\n    </div>\n  )\n}\n\ninterface SlippagePopoverProps {\n  value: string\n  onChange: (value: string) => void\n  presets?: string[]\n}\n\nconst SlippagePopover = ({\n  value,\n  onChange,\n  presets = [\"0.5\", \"1.0\", \"2.0\"],\n}: SlippagePopoverProps) => {\n  return (\n    <Popover>\n      <PopoverTrigger asChild>\n        <button className=\"flex items-center gap-1 px-2.5 py-1 rounded-full bg-muted hover:bg-muted/80 transition-colors text-xs\">\n          <span className=\"text-muted-foreground\">Slip:</span>\n          <span className=\"text-primary font-medium\">\n            {value === \"Auto\" ? \"Auto\" : `${value}%`}\n          </span>\n          <Settings className=\"w-3 h-3 text-muted-foreground\" />\n        </button>\n      </PopoverTrigger>\n      <PopoverContent align=\"end\" className=\"w-48 p-2\">\n        <div className=\"space-y-2\">\n          <div className=\"text-xs font-medium\">Slippage Tolerance</div>\n          <div className=\"flex gap-1\">\n            <button\n              onClick={() => onChange(\"Auto\")}\n              className={cn(\n                \"flex-1 px-2 py-1.5 rounded text-xs font-medium transition-colors\",\n                value === \"Auto\"\n                  ? \"bg-primary text-primary-foreground\"\n                  : \"bg-muted hover:bg-muted/80\"\n              )}\n            >\n              Auto\n            </button>\n            {presets.map((preset) => (\n              <button\n                key={preset}\n                onClick={() => onChange(preset)}\n                className={cn(\n                  \"flex-1 px-2 py-1.5 rounded text-xs font-medium transition-colors\",\n                  value === preset\n                    ? \"bg-primary text-primary-foreground\"\n                    : \"bg-muted hover:bg-muted/80\"\n                )}\n              >\n                {preset}%\n              </button>\n            ))}\n          </div>\n        </div>\n      </PopoverContent>\n    </Popover>\n  )\n}\n\nconst QuoteCountdown = ({\n  expiresAt,\n  onExpire,\n}: {\n  expiresAt: number\n  onExpire: () => void\n}) => {\n  const [secondsLeft, setSecondsLeft] = React.useState(\n    Math.max(0, Math.floor((expiresAt - Date.now()) / 1000))\n  )\n\n  React.useEffect(() => {\n    const interval = setInterval(() => {\n      const remaining = Math.max(0, Math.floor((expiresAt - Date.now()) / 1000))\n      setSecondsLeft(remaining)\n      if (remaining === 0) {\n        onExpire()\n        clearInterval(interval)\n      }\n    }, 1000)\n    return () => clearInterval(interval)\n  }, [expiresAt, onExpire])\n\n  if (secondsLeft <= 0) return null\n  return (\n    <span className={cn(secondsLeft <= 10 && \"text-yellow-500\")}>{secondsLeft}s</span>\n  )\n}\n\n// =============================================================================\n// MAIN COMPONENT\n// =============================================================================\n\nconst SwapWidget = React.forwardRef<HTMLDivElement, SwapWidgetProps>(\n  (\n    {\n      payToken,\n      receiveToken,\n      slippage: initialSlippage = \"Auto\",\n      slippagePresets,\n      nativeGasReserve = \"0.01\",\n      quoteRefreshInterval = 30000,\n      quoteDebounceMs = 300,\n      disabled = false,\n      disabledMessage,\n      onQuoteRequest,\n      onSwap,\n      onFlip,\n      onPayTokenSelect,\n      onReceiveTokenSelect,\n      onError,\n      className,\n    },\n    ref\n  ) => {\n    const [payAmount, setPayAmount] = React.useState(\"\")\n    const [receiveAmount, setReceiveAmount] = React.useState(\"\")\n    const [slippage, setSlippage] = React.useState(initialSlippage)\n    const [quote, setQuote] = React.useState<SwapQuote | null>(null)\n    const [status, setStatus] = React.useState<SwapStatus>(\"idle\")\n    const [error, setError] = React.useState<SwapError | null>(null)\n\n    const abortControllerRef = React.useRef<AbortController | null>(null)\n    const quoteIntervalRef = React.useRef<NodeJS.Timeout | null>(null)\n\n    const payAmountNum = parseFloat(payAmount) || 0\n    const payBalance = parseBalance(payToken.balance)\n    const payUsdValue = payAmountNum * payToken.price\n    const receiveAmountNum = parseFloat(receiveAmount) || 0\n    const receiveUsdValue = receiveAmountNum * receiveToken.price\n\n    const maxPayAmount = payToken.isNative\n      ? Math.max(0, payBalance - parseFloat(nativeGasReserve))\n      : payBalance\n\n    const insufficientBalance = payAmountNum > payBalance\n    const exceedsMax = payAmountNum > maxPayAmount && payToken.isNative\n    const hasValidAmount = payAmountNum > 0\n    const isQuoteExpired = quote?.expiresAt ? Date.now() > quote.expiresAt : false\n\n    const hasError = insufficientBalance || exceedsMax\n    const canSwap =\n      hasValidAmount &&\n      !hasError &&\n      !disabled &&\n      status !== \"quoting\" &&\n      status !== \"swapping\" &&\n      quote !== null &&\n      !isQuoteExpired\n\n    const getErrorMessage = (): string | undefined => {\n      if (insufficientBalance) return `Insufficient ${payToken.symbol}`\n      if (exceedsMax) return `Reserve ${nativeGasReserve} ${payToken.symbol} for gas`\n      return undefined\n    }\n\n    const getButtonConfig = () => {\n      if (disabled) return { text: disabledMessage || \"Trading disabled\", disabled: true }\n      if (status === \"swapping\") return { text: \"Swapping...\", disabled: true }\n      if (!hasValidAmount) return { text: \"Enter amount\", disabled: true }\n      if (hasError) return { text: getErrorMessage() || \"Error\", disabled: true }\n      if (status === \"quoting\") return { text: \"Getting quote...\", disabled: true }\n      if (isQuoteExpired) return { text: \"Quote expired\", disabled: true }\n      return { text: \"Swap\", disabled: false }\n    }\n\n    const fetchQuote = React.useCallback(\n      async (amount: string) => {\n        if (abortControllerRef.current) abortControllerRef.current.abort()\n\n        const amountNum = parseFloat(amount)\n        if (!amount || amountNum <= 0 || disabled) {\n          setReceiveAmount(\"\")\n          setQuote(null)\n          setStatus(\"idle\")\n          return\n        }\n\n        if (amountNum > payBalance) {\n          setReceiveAmount(\"\")\n          setQuote(null)\n          return\n        }\n\n        abortControllerRef.current = new AbortController()\n        setStatus(\"quoting\")\n        setError(null)\n\n        try {\n          if (onQuoteRequest) {\n            const newQuote = await onQuoteRequest({\n              payToken,\n              receiveToken,\n              payAmount: amount,\n              slippage,\n            })\n\n            if (abortControllerRef.current?.signal.aborted) return\n\n            if (newQuote) {\n              setQuote(newQuote)\n              setReceiveAmount(newQuote.receiveAmount)\n              setStatus(\"ready\")\n            } else {\n              setReceiveAmount(\"\")\n              setQuote(null)\n              setStatus(\"idle\")\n            }\n          } else {\n            // Mock quote for development\n            const mockRate = receiveToken.price > 0 ? payToken.price / receiveToken.price : 1\n            const receive = (amountNum * mockRate).toFixed(6)\n            const slippageMultiplier = getSlippageMultiplier(slippage)\n\n            setReceiveAmount(receive)\n            setQuote({\n              receiveAmount: receive,\n              exchangeRate: mockRate,\n              priceImpact: amountNum > 10 ? 2.5 : 0.1,\n              minReceived: (parseFloat(receive) * slippageMultiplier).toFixed(6),\n              expiresAt: Date.now() + 30000,\n            })\n            setStatus(\"ready\")\n          }\n        } catch (err) {\n          if (abortControllerRef.current?.signal.aborted) return\n          const swapError: SwapError = {\n            code: \"QUOTE_FAILED\",\n            message: err instanceof Error ? err.message : \"Failed to get quote\",\n          }\n          setError(swapError)\n          setStatus(\"error\")\n          onError?.(swapError)\n        }\n      },\n      [payToken, receiveToken, slippage, payBalance, disabled, onQuoteRequest, onError]\n    )\n\n    React.useEffect(() => {\n      const debounce = setTimeout(() => fetchQuote(payAmount), quoteDebounceMs)\n      return () => clearTimeout(debounce)\n    }, [payAmount, fetchQuote, quoteDebounceMs])\n\n    React.useEffect(() => {\n      setPayAmount(\"\")\n      setReceiveAmount(\"\")\n      setQuote(null)\n      setError(null)\n      setStatus(\"idle\")\n    }, [payToken.symbol, receiveToken.symbol])\n\n    React.useEffect(() => {\n      if (quoteRefreshInterval <= 0 || !hasValidAmount || disabled) {\n        if (quoteIntervalRef.current) clearInterval(quoteIntervalRef.current)\n        return\n      }\n\n      quoteIntervalRef.current = setInterval(() => {\n        if (payAmount && status === \"ready\") fetchQuote(payAmount)\n      }, quoteRefreshInterval)\n\n      return () => {\n        if (quoteIntervalRef.current) clearInterval(quoteIntervalRef.current)\n      }\n    }, [quoteRefreshInterval, hasValidAmount, disabled, payAmount, status, fetchQuote])\n\n    React.useEffect(() => {\n      return () => {\n        if (abortControllerRef.current) abortControllerRef.current.abort()\n        if (quoteIntervalRef.current) clearInterval(quoteIntervalRef.current)\n      }\n    }, [])\n\n    const handleQuickAmount = (percent: number) => {\n      if (disabled) return\n      const baseAmount = percent === 100 ? maxPayAmount : payBalance\n      const amount = (baseAmount * percent) / 100\n      setPayAmount(amount.toFixed(Math.min(payToken.decimals || 9, 6)))\n    }\n\n    const handleFlip = () => {\n      if (disabled) return\n      const tempPay = payAmount\n      setPayAmount(receiveAmount)\n      setReceiveAmount(tempPay)\n      setQuote(null)\n      setError(null)\n      onFlip?.()\n    }\n\n    const handleSwap = async () => {\n      if (!canSwap || !quote) return\n\n      setStatus(\"swapping\")\n      setError(null)\n\n      try {\n        await onSwap?.({\n          payToken,\n          receiveToken,\n          payAmount,\n          receiveAmount,\n          minReceived: quote.minReceived,\n          slippage,\n          quote,\n        })\n        setStatus(\"success\")\n        setPayAmount(\"\")\n        setReceiveAmount(\"\")\n        setQuote(null)\n        setTimeout(() => setStatus(\"idle\"), 2000)\n      } catch (err) {\n        const swapError: SwapError = {\n          code: \"UNKNOWN\",\n          message: err instanceof Error ? err.message : \"Swap failed\",\n        }\n        setError(swapError)\n        setStatus(\"error\")\n        onError?.(swapError)\n      }\n    }\n\n    const buttonConfig = getButtonConfig()\n\n    return (\n      <div ref={ref} className={cn(\"space-y-2\", className)}>\n        {disabled && disabledMessage && (\n          <div className=\"flex items-center gap-2 px-3 py-2 rounded-lg bg-yellow-500/10 border border-yellow-500/20\">\n            <AlertTriangle className=\"w-4 h-4 text-yellow-500 flex-shrink-0\" />\n            <span className=\"text-xs text-yellow-500\">{disabledMessage}</span>\n          </div>\n        )}\n\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-1.5\">\n            <span className=\"text-xs font-semibold\">Pay</span>\n            {[25, 50, 100].map((pct) => (\n              <button\n                key={pct}\n                onClick={() => handleQuickAmount(pct)}\n                disabled={disabled}\n                className=\"px-2 py-0.5 rounded-full bg-muted text-[10px] text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50\"\n              >\n                {pct === 100 ? \"Max\" : `${pct}%`}\n              </button>\n            ))}\n          </div>\n          <div className=\"flex items-center gap-2\">\n            {quote && hasValidAmount && (\n              <button\n                onClick={() => fetchQuote(payAmount)}\n                disabled={status === \"quoting\" || disabled}\n                className=\"p-1 rounded-full hover:bg-muted transition-colors disabled:opacity-50\"\n              >\n                <RefreshCw\n                  className={cn(\n                    \"w-3 h-3 text-muted-foreground\",\n                    status === \"quoting\" && \"animate-spin\"\n                  )}\n                />\n              </button>\n            )}\n            <SlippagePopover\n              value={slippage}\n              onChange={setSlippage}\n              presets={slippagePresets}\n            />\n          </div>\n        </div>\n\n        <div className=\"relative\">\n          <SwapCard\n            value={payAmount}\n            onChange={setPayAmount}\n            token={payToken}\n            usdValue={payUsdValue}\n            onTokenSelect={onPayTokenSelect}\n            disabled={disabled}\n            hasError={hasError && hasValidAmount}\n            errorMessage={hasValidAmount ? getErrorMessage() : undefined}\n          />\n\n          <div className=\"h-3\" />\n\n          <SwapCard\n            value={receiveAmount}\n            onChange={() => {}}\n            token={receiveToken}\n            usdValue={receiveUsdValue}\n            onTokenSelect={onReceiveTokenSelect}\n            disabled={true}\n            isCalculating={status === \"quoting\"}\n          />\n\n          <button\n            onClick={handleFlip}\n            disabled={disabled}\n            className=\"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 p-2.5 rounded-full bg-background border border-border hover:bg-muted transition-colors disabled:opacity-50\"\n          >\n            <ArrowDownUp className=\"w-4 h-4\" />\n          </button>\n        </div>\n\n        <Button\n          className=\"w-full h-11 mt-2\"\n          onClick={handleSwap}\n          disabled={buttonConfig.disabled}\n        >\n          {status === \"swapping\" && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n          {buttonConfig.text}\n        </Button>\n\n        {quote && hasValidAmount && !hasError && (\n          <div className=\"flex items-center justify-center gap-2 text-[10px] text-muted-foreground pt-1\">\n            <span>\n              Min: {formatNumber(quote.minReceived)} {receiveToken.symbol}\n            </span>\n            <span>·</span>\n            <span className={getPriceImpactColor(quote.priceImpact)}>\n              Impact: {quote.priceImpact < 0.01 ? \"<0.01\" : quote.priceImpact.toFixed(2)}%\n            </span>\n            {quote.expiresAt && (\n              <>\n                <span>·</span>\n                <QuoteCountdown expiresAt={quote.expiresAt} onExpire={() => setStatus(\"idle\")} />\n              </>\n            )}\n          </div>\n        )}\n\n        {error && status === \"error\" && (\n          <div className=\"flex items-center gap-2 px-3 py-2 rounded-lg bg-destructive/10 text-xs text-destructive\">\n            <AlertTriangle className=\"w-3 h-3 flex-shrink-0\" />\n            {error.message}\n          </div>\n        )}\n      </div>\n    )\n  }\n)\n\nSwapWidget.displayName = \"SwapWidget\"\n\nexport { SwapWidget }\n"
    }
  ]
}